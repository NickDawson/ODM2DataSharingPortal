{% extends 'dataloaderinterface/base.html' %}
{% load staticfiles %}

{% block content %}
    <div class="container main-content">
        <div class="row">
            <section class="device-data col-lg-12">
        <header>
            <h2>
                {% if sampling_feature.sampling_feature_name %}
                    {{ sampling_feature.sampling_feature_name }} ({{ sampling_feature.sampling_feature_code }})
                {% else %}
                    {{ sampling_feature.sampling_feature_code }}
                {% endif %}
            </h2>
            <div class="col-lg-12 registration-keys clearfix">
                <h4>
{#                    <span class="glyphicon copy-icon glyphicon-copy" title="Copy registration token"></span> #}
                    Registration Token: <span class="key registration-token">{{ object.authentication_token }}</span></h4>
                <h4>
{#                    <span class="glyphicon copy-icon glyphicon-copy" title="Copy sampling feature uuid"></span> #}
                    Sampling Feature UUID: <span class="key site-uuid">{{ sampling_feature.sampling_feature_uuid }}</span></h4>
            </div>
        </header>
        {% if messages %}
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        {% endif %}

        <div class="detail-map-container col-lg-12">
            <div id="map"></div>
        </div>

        <div class="registration-data col-lg-12">
            {# Deployment fields #}
            <div class="col-lg-12 row">
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Deployment Lead</span>
                    <span id="field-affiliation" class="control-field col-lg-8">{{ affiliation }}</span>
                </div>
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Deployment Date</span>
                    <span id="field-start-datetime" class="control-field col-lg-8">{{ deployment.begin_datetime }}</span>
                </div>
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Deployment Method</span>
                    <span id="field-method" class="control-field col-lg-8">{{ deployment.method }}</span>
                </div>
            </div>

            <div class="col-lg-12 row">
                {# Sampling Feature fields #}
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Site Code</span>
                    <span id="field-site-code" class="control-field col-lg-8">{{ sampling_feature.sampling_feature_code }}</span>
                </div>
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Elevation (m)</span>
                    <span id="field-elevation" class="control-field col-lg-8">{{ sampling_feature.elevation_m }}</span>
                </div>
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Elevation Datum</span>
                    <span id="field-elevation-datum" class="control-field col-lg-8">{{ sampling_feature.elevation_datum_id }}</span>
                </div>
            </div>

            <div class="col-lg-12 row">
                {# Site fields #}
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Site Type</span>
                    <span id="field-site-type" class="control-field col-lg-8">{{ site.site_type_id }}</span>

                </div>
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Latitude</span>
                    <span id="field-latitude" class="control-field col-lg-8">{{ site.latitude }}</span>

                </div>
                <div class="registration-field col-lg-4 col-md-6">
                    <span class="control-label col-lg-4">Longitude</span>
                    <span id="field-longitude" class="control-field col-lg-8">{{ site.longitude }}</span>
                </div>
            </div>
        </div>

        <div class="measurements-container col-lg-12">
            <div class="col-lg-12">
                <h3>Recent Measurements</h3>
                <button type="button" class="btn btn-default download-data-button" data-result-id>Download <span class="variable-name"></span> raw data</button>
                <h4>Only last 24 hours shown on sparkline plots and tables</h4>
            </div>

            <div class="sparkline-plots col-lg-6">
                {% for feature_action in feature_actions %}
                    {% with feature_action.results.all.0 as result %}
                        <div class="plot_box" data-result-id="{{ result.result_id }}" data-variable-name="{{ result.variable.variable_name_id }}">
                            <div class="variable-data">
                                <span class="variable-name">{{ result.variable.variable_name_id }}</span>
                                <span class="variable-code">{{ result.variable.variable_code }}</span>
                                <span class="latest-value">{{ result.timeseriesresult.values.last.data_value|floatformat:-3 }}</span>
                                <span class="unit">{{ result.unit.unit_abbreviation }}</span>
                                <div class="clearfix"></div>
                            </div>
                            <div id="graph{{ forloop.counter0 }}" class="graph-container"></div>
                        </div>
                    {% endwith %}
                {% endfor %}
            </div>
            <div class="measurements-table col-lg-6">
                {% for feature_action in feature_actions %}
                    {% with feature_action.results.first as result %}
                        <table class="table table-striped table-bordered data-values {{ result.variable.variable_code }}"
                               cellspacing="0" width="100%" data-result-id="{{ result.result_id }}">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Value</th>
                                </tr>
                            </thead>

                            <tbody>
                                {% for series_value in result.timeseriesresult.values.all %}
                                    <tr>
                                        <td>{{ series_value.value_datetime }}</td>
                                        <td>{{ series_value.data_value }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr><td>result uuid: <span class="result-uuid">{{ result.result_uuid }}</span></td></tr>
                            </tfoot>
                        </table>
                    {% endwith %}
                {% endfor %}
            </div>
        </div>
    </section>
        </div>
    </div>

{% endblock %}

{% block styles %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs-3.3.6/dt-1.10.12/fh-3.1.2/r-2.1.0/sc-1.4.2/datatables.min.css"/>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs-3.3.6/dt-1.10.12/fh-3.1.2/r-2.1.0/sc-1.4.2/datatables.min.js"></script>
    <script src="{% static 'dataloaderinterface/js/device-detail.js' %}"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiUxiuZaPEPtB4EhAquguz7kNzYU7bnnc&callback=initMap"></script>
{% endblock %}

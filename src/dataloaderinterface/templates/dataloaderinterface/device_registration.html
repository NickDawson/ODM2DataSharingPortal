{% extends 'dataloaderinterface/base.html' %}
{% load staticfiles %}
{% load widget_tweaks %}

{% block content %}
    <section class="page-content device-data col-lg-12">
        <header>
            <h2>Register a Site</h2>
            {% if messages %}
                {% for message in messages %}
                    <span class="form-message {{ message.tags }}">{{ message }}</span>
                {% endfor %}
            {% endif %}
        </header>

        <form method="post" enctype="multipart/form-data" role="form">
            {% csrf_token %}
            <input name="user_first_name" type="hidden" value="{{ user.first_name }}">
            <input name="user_last_name" type="hidden" value="{{ user.last_name }}">

            <div class="separator"></div>

            <fieldset class="form-fieldset col-lg-12">
                <legend></legend>
                <div class="form-group col-lg-4 sampling-feature-fields">
                    {% for field in sampling_feature_form %}
                        <div class="form-field col-lg-12{% if field.field.required %} required-field{% endif %}{% if field.errors %} has-error{% endif %}"
                             data-field="{{ field.name }}">
                            <label class="control-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field|add_class:"form-control input-sm" }}
                        </div>
                    {% endfor %}
                    {% for field in site_form %}
                        <div class="form-field col-lg-12{% if field.field.required %} required-field{% endif %}{% if field.errors %} has-error{% endif %}"
                             data-field="{{ field.name }}">
                            <label class="control-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field|add_class:"form-control input-sm" }}
                        </div>
                    {% endfor %}
                </div>
                <div class="form-group col-lg-8 map-container">
                    <input type="hidden" name="zoom-level" value="{{ zoom_level }}">
                    <div id="map"></div>
                </div>
                <div class="clearfix"></div>
            </fieldset>

            <div class="col-lg-12">
                <div class="separator"></div>
            </div>


            <fieldset class="form-fieldset col-lg-12">
                <div class="col-lg-12 results-table" id="formset" data-formset-prefix="{{ results_formset.prefix }}">
                    <h3>Sensors</h3>
                    <button id="new-result-button" type="button" class="btn btn-default" data-toggle="modal" data-target="#result-dialog">Add Sensor</button>

                    {{ results_formset.management_form }}
                    <table class="table table-striped table-bordered sensors">
                        <thead>
                        <tr>
                            <th>Equipment Model</th>
                            <th>Measured Variable</th>
                            <th>Units</th>
                            <th>Sampled Medium</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for result_form in results_formset %}
                            {% if result_form.is_bound %}
                                <tr class="result-form" data-result="{{ result_form.prefix }}">
                                    {% for field in result_form %}
                                        <td data-field="{{ field.name }}">
                                            <span class="field-text">{{ field.data }}</span>
                                            <input type="hidden" name="{{ field.html_name }}" class="field-value"
                                                   value=""/>
                                        </td>
                                    {% endfor %}
                                    <td data-behaviour="edit">
                                        <button class="btn btn-primary btn-xs" type="button">
                                            <span class="glyphicon glyphicon-pencil"></span>
                                        </button>
                                    </td>
                                    <td data-behaviour="delete">
                                        <button class="btn btn-danger btn-xs" type="button">
                                            <span class="glyphicon glyphicon-trash"></span>
                                        </button>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                    </table>

                    <script id="sensor-row" type="text/plain">
                        <tr class="result-form" data-result="">
                            <td data-field="equipment_model">
                                <span class="field-text"></span>
                                <input type="hidden" name="form-__prefix__-equipment_model" class="field-value" value="" />
                            </td>
                            <td data-field="variable">
                                <span class="field-text"></span>
                                <input type="hidden" name="form-__prefix__-variable" class="field-value" value="" />
                            </td>
                            <td data-field="unit">
                                <span class="field-text"></span>
                                <input type="hidden" name="form-__prefix__-unit" class="field-value" value="" />
                            </td>
                            <td data-field="sampled_medium">
                                <span class="field-text"></span>
                                <input type="hidden" name="form-__prefix__-sampled_medium" class="field-value" value="" />
                            </td>
                            <td data-behaviour="edit">
                                <button class="btn btn-primary btn-xs" type="button">
                                    <span class="glyphicon glyphicon-pencil"></span>
                                </button>
                            </td>
                            <td data-behaviour="delete">
                                <button class="btn btn-danger btn-xs" type="button" data-toggle="modal" data-target="#confirm-delete">
                                    <span class="glyphicon glyphicon-trash"></span>
                                </button>
                            </td>
                        </tr>

                    </script>
                </div>


            </fieldset>
            <div class="clearfix"></div>

            <div class="col-lg-12 register-button">
                <input type="submit" value="Register Site" class="btn btn-primary">
            </div>
        </form>
    </section>

    <div id="result-dialog" class="modal fade" role="dialog" aria-hidden="true">
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4>Add Sensor</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group col-lg-12 result-form">
                            {% for field in results_formset.empty_form %}
                                <div class="form-field col-lg-12 {% if field.field.required %}required-field{% endif %} {% if field.errors %}has-error{% endif %}">
                                    <label class="control-label" for="{{ field.id_for_label }}">{{ field.label }}</label> {{ field.errors }}
                                    {{ field|add_class:"form-control input-sm" }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button id="edit-sensor-button" type="button" class="btn btn-primary">Update Sensor</button>
                        <button id="add-sensor-button" type="button" class="btn btn-primary">Add New Sensor</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirm-delete" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Delete sensor</h4>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to remove this sensor from the list?</p>
                    <input id="" type="hidden" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" >Cancel</button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete" >Delete</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block services_urls %}
    {{ block.super }}
    <input id="model-variables-api" type="hidden" value="{% url 'model_variables_service' %}">
    <input id="result-validation-api" type="hidden" value="{% url 'result_validation_service' %}">
{% endblock %}

{% block styles %}
    {{ block.super }}
    <link href="https://cdn.datatables.net/v/bs-3.3.6/dt-1.10.12/fh-3.1.2/r-2.1.0/sc-1.4.2/datatables.min.css"
          rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.6/select2-bootstrap.min.css"
          rel="stylesheet"/>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="https://cdn.datatables.net/v/bs-3.3.6/dt-1.10.12/fh-3.1.2/r-2.1.0/sc-1.4.2/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.min.js"></script>
    <script src="{% static 'dataloaderinterface/js/common-forms.js' %}"></script>
    <script src="{% static 'dataloaderinterface/js/device-form.js' %}"></script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiUxiuZaPEPtB4EhAquguz7kNzYU7bnnc&callback=initMap"></script>
{% endblock %}


{% extends 'dataloaderinterface/base.html' %}

{% block content %}

<!--suppress JSUnfilteredForInLoop -->
<style>

</style>

<table id="resource-table" class="mdl-data-table mdl-js-data-table">
    <thead>
    <tr id="res-header-row">
        <th>Header 1</th>
    </tr>
    </thead>
    <tbody id="res-table-body">
        <tr>
            <td>data 1</td>
        </tr>
    </tbody>
</table>

{% endblock %}

{% block scripts %}
{{ super.block }}
<script>
    const cellClassName = "mdl-data-table__cell--non-numeric";

    let resources = '{{ resources_json }}'.replace(/\&quot;/g, '"');
    resources = JSON.parse(resources);
    console.log(resources);

    {#deleteResourceByValue(resources, 'public', false);#}
    {#deleteResources(resources, ['resource_id', 'immutable', 'coverages', 'public']);#}

    function buildTable() {

        let keys = Object.keys(resources[0]).sort();
        let headers = orderKeysBy(keys, ['resource_title', 'creator', 'date_created']);

        buildTableHeaderRow(headers);
        buildTableBody(headers);

    }

    function buildTableHeaderRow(headers) {
        const tableHeaderRow = document.getElementById('res-header-row');
        let innerHTML = '';
        for (let header of headers) {
            header = formatHeader(header);
            innerHTML += `<th class="${cellClassName}">${header}</th>`;
        }
        tableHeaderRow.innerHTML = innerHTML;

        function formatHeader(header) {
            return header.split('_').map(function (value) {
                return value.charAt(0).toUpperCase() + value.slice(1);
            }).join(' ');
        }
    }

    function buildTableBody(headers) {
        const tableBody = document.getElementById('res-table-body');
        tableBody.innerHTML = "";
        let innerHTML = "";
        for (let resource of resources) {
            innerHTML += `<tr>`;
            for (let header of headers) {
                let innerRowHTML = resource[header];
                if (typeof innerRowHTML === 'string' && innerRowHTML.match(/http:\/\//)) {
                    if (innerRowHTML.match(/\.zip/)) {
                        innerRowHTML = `<a href=${innerRowHTML}>Download .zip</a>`;
                    } else if (innerRowHTML.match(/\/hsapi\/resource\/\S{32}\/map\/$/i)) {
                        innerRowHTML = `<a href=${innerRowHTML}>Map</a>`;
                    } else if (innerRowHTML.match(/\/resource\/\S{32}\/$/i)) {
                        innerRowHTML = `<a href=${innerRowHTML}>Resource</a>`;
                    } else if (innerRowHTML.match(/\/hsapi\/resource\/\S{32}\/scimeta\/$/i)) {
                        innerRowHTML = `<a href=${innerRowHTML}>Metadata</a>`;
                    }
                } else if (Array.isArray(innerRowHTML) && innerRowHTML.length) {
                    innerRowHTML = `<code>${innerRowHTML}</code>`;
                }
                innerHTML += `<td class="${cellClassName}">${innerRowHTML}</td>`;
            }
            innerHTML += `</tr>`;
        }
        tableBody.innerHTML = innerHTML;
    }

    function deleteResources(resources, keys) {
        for (let res of resources) {
            for (let key of keys) {
                delete res[key];
            }
        }
    }

    function deleteResourceByValue(resources, key, value) {
        let deleteIndexStack = [];
        for (let index in resources) {
            let resource = resources[index];
            if (resource[key] === value) {
                deleteIndexStack.push(index);
            }
        }
        for (let index in deleteIndexStack) {
            resources.splice(index, 1);
        }
        return resources;
    }

    function orderKeysBy(keys, orderedBy) {
        let orderedKeys = keys.slice(0).sort();
        orderedBy.reverse();
        for (let key of orderedBy) {
            let index = orderedKeys.indexOf(key);
            console.log(`index of ${key}: ${index}`);
            if (index > -1) {
                orderedKeys.splice(orderedKeys.indexOf(key), 1);
                console.log(`KEYS after removing ${key.toUpperCase()}`, orderedKeys);
                orderedKeys.unshift(key);
            }
        }
        console.log(`KEYS`, orderedKeys);
        return orderedKeys;
    }

    buildTable();

</script>
{% endblock %}